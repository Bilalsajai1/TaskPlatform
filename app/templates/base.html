<!DOCTYPE html>
<html>
<head>
    <title>Task Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <style>
    body { background: linear-gradient(135deg, #f8fbff 0%, #f0f4ff 100%); min-height: 100vh; }
    .navbar { box-shadow: 0 6px 20px rgba(13,110,253,0.12); backdrop-filter: blur(10px); }
    .nav-link { transition: color .2s ease, transform .2s ease; }
    .nav-link:hover { transform: translateY(-1px); }
    .card-hover { transition: transform .2s ease, box-shadow .2s ease; }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 16px 30px rgba(13,110,253,0.15); }
    .btn { transition: transform .2s ease; }
    .btn:hover { transform: translateY(-1px); }
    .glass { background: rgba(255,255,255,0.7); border: 1px solid rgba(255,255,255,0.4); backdrop-filter: blur(8px); }
    .accent { background: linear-gradient(45deg, #0d6efd, #6f42c1); color: #fff; }
    .toast-container {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 1060;
    }
    .slide-in {
        animation: slideIn 300ms ease-out;
    }
    .fade-out {
        animation: fadeOut 600ms ease-in forwards;
    }
    @keyframes slideIn {
        from { transform: translateY(-10px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }
    </style>
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <div class="container">
            <a class="navbar-brand fw-bold" href="{{ url_for('main.index') }}">Task Platform</a>
            <div class="navbar-nav">
                {% if current_user.is_authenticated %}
                    <a class="nav-link" href="{{ url_for('main.dashboard') }}">Dashboard</a>
                    {% if current_user.role == 'admin' %}
                        <a class="nav-link" href="{{ url_for('main.register') }}">Register User</a>
                    {% endif %}
                    <a class="nav-link position-relative" href="#" id="notifBell">
                        Notifications
                        <span id="notifBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display:none;">0</span>
                    </a>
                    <a class="nav-link" href="{{ url_for('main.logout') }}">Logout</a>
                {% else %}
                    <a class="nav-link" href="{{ url_for('main.login') }}">Login</a>
                {% endif %}
            </div>
        </div>
    </nav>
    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        <div id="realtime-alerts"></div>
        {% if current_user.is_authenticated %}
        <div class="mb-3 d-flex gap-2">
            <button id="show-history" class="btn btn-sm btn-secondary">Voir l'historique des notifications</button>
            <button id="mark-all-read" class="btn btn-sm btn-outline-secondary">Tout marquer comme lu</button>
        </div>
        <ul id="notifications" class="list-group mb-3 animate__animated animate__fadeIn"></ul>
        {% endif %}
        {% block content %}{% endblock %}
    </div>
    <div class="toast-container" id="toast-container"></div>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Preview Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content glass">
          <div class="modal-header">
            <h5 class="modal-title">Aperçu du fichier</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" style="height:70vh">
            <iframe id="previewFrame" src="about:blank" style="border:0;width:100%;height:100%"></iframe>
          </div>
        </div>
      </div>
    </div>
    <script>
    (function(){
        var mode = localStorage.getItem('theme') || 'light';
        if(mode === 'dark') document.documentElement.setAttribute('data-bs-theme','dark');
    })();
    </script>
    {% if current_user.is_authenticated %}
    <script>
    (function(){
        var socket = io();
        socket.on('connect', function(){
            socket.emit('join', { user_id: '{{ current_user.id }}' });
        });
        function pushNotification(text){
            var ul = document.getElementById('notifications');
            if(!ul) return;
            var li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = text;
            ul.prepend(li);
        }
        function updateBadge(count){
            var badge = document.getElementById('notifBadge');
            if(!badge) return;
            if(count > 0){
                badge.style.display = 'inline-block';
                badge.textContent = count;
            } else {
                badge.style.display = 'none';
            }
        }
        function showToast(message){
            var container = document.getElementById('toast-container');
            if(!container) return;
            var wrapper = document.createElement('div');
            wrapper.className = 'toast align-items-center text-bg-primary border-0 slide-in animate__animated animate__fadeInDown';
            wrapper.setAttribute('role', 'alert');
            wrapper.setAttribute('aria-live', 'assertive');
            wrapper.setAttribute('aria-atomic', 'true');
            wrapper.style.minWidth = '320px';
            wrapper.innerHTML = '<div class="d-flex">\
                <div class="toast-body">'+ message +'</div>\
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>\
            </div>';
            container.appendChild(wrapper);
            var bsToast = new bootstrap.Toast(wrapper, { delay: 20000, autohide: true });
            bsToast.show();
            wrapper.addEventListener('hidden.bs.toast', function(){
                wrapper.classList.add('fade-out');
                setTimeout(function(){ wrapper.remove(); }, 600);
            });
        }
        socket.on('notification', function(data){
            pushNotification(data.message);
            showToast(data.message);
            var current = parseInt(document.getElementById('notifBadge').textContent || '0');
            updateBadge(current + 1);
        });
        function getCookie(name){
            var m=document.cookie.match(new RegExp('(?:^|; )'+name.replace(/([.$?*|{}()\[\]\\\/\+^])/g,'\\$1')+'=([^;]*)'));
            return m?decodeURIComponent(m[1]):undefined;
        }
        var btn = document.getElementById('show-history');
        if(btn){
            btn.addEventListener('click', function(){
                fetch("{{ url_for('main.notifications_history') }}")
                    .then(function(r){ return r.json(); })
                    .then(function(payload){
                        var ul = document.getElementById('notifications');
                        ul.innerHTML = '';
                        payload.items.forEach(function(n){
                            pushNotification(n.message + ' — ' + new Date(n.created_at).toLocaleString());
                        });
                        updateBadge(payload.unread_count);
                    });
            });
        }
        var markBtn = document.getElementById('mark-all-read');
        if(markBtn){
            markBtn.addEventListener('click', function(){
                fetch("{{ url_for('main.notifications_mark_all_read') }}", { method: 'POST', headers: { 'X-Requested-With': 'fetch', 'X-CSRFToken': getCookie('csrf_token') }})
                    .then(function(){ updateBadge(0); });
            });
        }
        // Initialize unread count on load
        fetch("{{ url_for('main.notifications_history') }}")
            .then(function(r){ return r.json(); })
            .then(function(payload){ updateBadge(payload.unread_count || 0); });
        // Preview modal binding
        document.body.addEventListener('click', function(e){
            var link = e.target.closest('[data-preview]');
            if(link){
                e.preventDefault();
                var url = link.getAttribute('href');
                var frame = document.getElementById('previewFrame');
                frame.src = url;
                var modal = new bootstrap.Modal(document.getElementById('previewModal'));
                modal.show();
            }
        });
        // Theme toggle control
        var nav = document.querySelector('.navbar .navbar-nav');
        if(nav){
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e){
                if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                if(e.key === 'c' || e.key === 'C') { window.location.href = "{{ url_for('main.create_task') }}"; }
                if(e.key === '/') { e.preventDefault(); var q=document.querySelector('input[name=q]'); if(q){ q.focus(); } }
                if(e.key === 'h' || e.key === 'H') { var btn=document.getElementById('show-history'); if(btn){ btn.click(); } }
            });
            var toggle = document.createElement('a');
            toggle.href = '#';
            toggle.className = 'nav-link';
            toggle.textContent = 'Theme';
            toggle.addEventListener('click', function(e){
                e.preventDefault();
                var current = document.documentElement.getAttribute('data-bs-theme') === 'dark' ? 'dark' : 'light';
                var next = current === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-bs-theme', next);
                localStorage.setItem('theme', next);
            });
            nav.appendChild(toggle);
        }
    })();
    </script>
    {% endif %}
</body>
</html>